{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4>Gerçek Zamanlı Şişe Tespiti</h4>
                </div>
                <div class="card-body">
                    <div class="image-container text-center">
                        <img src="/realtime/last_frame?t={{ timestamp }}" class="img-fluid" id="last-frame" style="max-height:400px;" alt="Son Fotoğraf">
                    </div>
                    <div class="mt-3">
                        <h5>Toplam Şişe: <span id="bottle-count">0</span></h5>
                    </div>
                    <div class="mt-3" id="qr-section" style="display:none;">
                        <h5>Puanınız: <span id="qr-points"></span></h5>
                        <img id="qr-img" src="" alt="QR Kod" style="max-width:200px;">
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h4>Kontrol Paneli</h4>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" id="start-btn">Tespiti Başlat</button>
                        <button class="btn btn-danger" id="stop-btn" disabled>Tespiti Durdur</button>
                    </div>
                    <div class="mt-3">
                        <div class="alert alert-info" role="alert" id="status-message">
                            Tespit başlatılmadı
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.image-container {
    background-color: #000;
    min-height: 200px;
    display: flex;
    align-items: center;
    justify-content: center;
}
</style>

<script>
let detectionActive = false;
let refreshInterval = null;
let lastFrameTimestamp = Date.now();

function updateBottleCountAndImage() {
    fetch('/realtime/get_bottle_count')
        .then(response => response.json())
        .then(data => {
            document.getElementById('bottle-count').textContent = data.bottle_count;
        });
    // Fotoğrafı güncelle (cache busting için timestamp ekle)
    const img = document.getElementById('last-frame');
    lastFrameTimestamp = Date.now();
    img.src = `/realtime/last_frame?t=${lastFrameTimestamp}`;
}

document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const statusMessage = document.getElementById('status-message');
    const qrSection = document.getElementById('qr-section');
    const qrImg = document.getElementById('qr-img');
    const qrPoints = document.getElementById('qr-points');

    startBtn.addEventListener('click', function() {
        fetch('/realtime/start_detection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                startBtn.disabled = true;
                stopBtn.disabled = false;
                statusMessage.textContent = 'Tespit başlatıldı';
                statusMessage.className = 'alert alert-success';
                detectionActive = true;
                qrSection.style.display = 'none';
                refreshInterval = setInterval(updateBottleCountAndImage, 2000);
            } else {
                statusMessage.textContent = data.message;
                statusMessage.className = 'alert alert-danger';
            }
        })
        .catch(error => {
            statusMessage.textContent = 'Bir hata oluştu: ' + error;
            statusMessage.className = 'alert alert-danger';
        });
    });

    stopBtn.addEventListener('click', function() {
        fetch('/realtime/stop_detection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                statusMessage.textContent = 'Tespit durduruldu';
                statusMessage.className = 'alert alert-info';
                detectionActive = false;
                if (refreshInterval) clearInterval(refreshInterval);
                // QR kodu oluştur
                fetch('/realtime/generate_qr')
                    .then(response => response.json())
                    .then(qrdata => {
                        qrSection.style.display = 'block';
                        qrImg.src = qrdata.qr_url + '?t=' + Date.now();
                        qrPoints.textContent = qrdata.points;
                    });
            } else {
                statusMessage.textContent = data.message;
                statusMessage.className = 'alert alert-danger';
            }
        })
        .catch(error => {
            statusMessage.textContent = 'Bir hata oluştu: ' + error;
            statusMessage.className = 'alert alert-danger';
        });
    });
});
</script>
{% endblock %} 